@using Radzen
@using Microsoft.AspNetCore.Components
@using System.Net.Mail
@using System.Net

<div class="rz-p-2">
    @if (!string.IsNullOrWhiteSpace(_settingsError))
    {
        <div class="rz-text-danger rz-mb-2">@_settingsError</div>
    }

    <EditForm Model="@_model" OnValidSubmit="SendAsync">
        <div class="rz-grid rz-g-2">
            <div>
                <RadzenLabel Text="From" />
                <RadzenTextBox @bind-Value="_model.From" Style="width:100%" />
            </div>
            <div>
                <RadzenLabel Text="To" />
                <RadzenTextBox @bind-Value="_model.To" Style="width:100%" />
            </div>
            <div style="grid-column: 1 / -1;">
                <RadzenLabel Text="Subject" />
                <RadzenTextBox @bind-Value="_model.Subject" Style="width:100%" />
            </div>
            <div style="grid-column: 1 / -1;">
                <RadzenLabel Text="Body" />
                <RadzenTextArea @bind-Value="_model.Body" Rows="8" Style="width:100%" />
            </div>
            <div class="rz-d-flex rz-justify-content-end rz-g-2" style="grid-column: 1 / -1;">
                <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@Cancel" />
                <RadzenButton ButtonStyle="ButtonStyle.Primary" Disabled="@_sending" Submit="true" Text="@(_sending ? "Sending..." : "Send")" />
            </div>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public string? DefaultTo { get; set; }

    [Inject] public DialogService DialogService { get; set; } = default!;

    private class ComposeModel
    {
        public string From { get; set; } = "sender@example.com";
        public string To { get; set; } = string.Empty;
        public string Subject { get; set; } = "Test from Blazor";
        public string Body { get; set; } = "This is a test email from the Blazor app.";
    }

    private readonly ComposeModel _model = new();

    private bool _sending;
    private string? _settingsError;

    protected override void OnParametersSet()
    {
        if (string.IsNullOrWhiteSpace(_model.To))
        {
            _model.To = DefaultTo ?? string.Empty;
        }
    }

    private Task Cancel()
    {
        DialogService.Close(false);
        return Task.CompletedTask;
    }

    private async Task SendAsync()
    {
        if (string.IsNullOrWhiteSpace(_model.To))
        {
            _settingsError = "Recipient (To) is required.";
            return;
        }

        try
        {
            _sending = true;
            // Send using local SMTP server settings used by SmtpTestClient
            using var client = new SmtpClient("localhost", 2525)
            {
                EnableSsl = false,
                Credentials = new NetworkCredential("Admin", "password")
            };

            var message = new MailMessage
            {
                From = new MailAddress(string.IsNullOrWhiteSpace(_model.From) ? "sender@example.com" : _model.From),
                Subject = _model.Subject,
                Body = _model.Body
            };
            message.To.Add(_model.To);

            await client.SendMailAsync(message);
            DialogService.Close(true);
        }
        catch (Exception ex)
        {
            _settingsError = $"Failed to send: {ex.Message}";
        }
        finally
        {
            _sending = false;
        }
    }
}

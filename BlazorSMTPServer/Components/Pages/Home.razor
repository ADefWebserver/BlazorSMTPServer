@page "/"
@using BlazorSMTPServer.Services
@using Azure.Data.Tables
@using BlazorSMTPServer.Components.Dialogs
@using System.Globalization
@using Microsoft.Extensions.Configuration
@using MimeKit
@inject BlobEmailService EmailService
@inject Microsoft.JSInterop.IJSRuntime JSRuntime
@inject Radzen.DialogService DialogService
@inject TableServiceClient TableServiceClient
@inject IConfiguration Configuration

<PageTitle>Inbox</PageTitle>

<!-- Two-column mail layout -->
<RadzenRow Style="height:calc(100vh - 40px);">
    <!-- Left column: compose + recipient + messages -->
    <RadzenColumn Size="3" Style="height:100%; display:flex; flex-direction:column; gap:10px;">
        <RadzenButton Text="New message" Icon="play_arrow" ButtonStyle="ButtonStyle.Success" Style="width:100%;" Click="@NewMessageClick" />

        <!-- Recipient selector -->
        <div style="display:flex; flex-direction:column; flex:1 1 auto; min-height:0;">
            @if (_recipientFolders is null)
            {
                <div class="rz-p-2"><em>Loading folders...</em></div>
            }
            else if (_recipientFolders.Count == 0)
            {
                <div class="rz-p-2 text-muted">No recipient folders found.</div>
            }
            else
            {
                <RadzenDropDown Data="@_recipientFolders"
                                 @bind-Value="_selectedRecipient"
                                 Change="@OnRecipientChanged"
                                 Placeholder="Select mailbox..."
                                 Style="margin-bottom:10px; width:100%;" />

                <!-- Messages list -->
                @if (_isLoadingMessages)
                {
                    <div class="rz-p-2"><em>Loading messages...</em></div>
                }
                else if (_messages is null || _messages.Count == 0)
                {
                    <div class="rz-p-2 rz-text-muted" style="text-align:center;">Empty list.</div>
                }
                else
                {
                    <RadzenListBox Data="@_messages" ValueProperty="Id" @bind-Value="_selectedMessageId" Change="@OnMessageChanged"
                                   Style="flex:1 1 auto; min-height:0; overflow:auto;">
                        <Template Context="m">
                            <div style="padding:4px 4px; display:flex; align-items:center; gap:6px; width:100%;">
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Click="@(async _ => await ConfirmDeleteAsync(m))" />
                                <div style="min-width:0; flex:1 1 auto;">
                                    <div style="font-weight:600;" class="rz-truncate" title="@DisplaySubject(m.Subject)">@DisplaySubject(m.Subject)</div>
                                    <div class="rz-truncate" title="@m.From">@m.From</div>
                                </div>
                            </div>
                        </Template>
                    </RadzenListBox>
                }
            }
        </div>
    </RadzenColumn>

    <!-- Right column: preview -->
    <RadzenColumn Size="9" Style="height:100%; min-width:0; display:flex; flex-direction:column;">
        <!-- Actions row -->
        <div class="rz-d-flex rz-align-items-center" style="gap:12px; padding:4px 0;">
            @if (_currentEmail is not null)
            {
                <RadzenButton Text="Reply" Icon="reply" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Click="@(_ => ReplyToCurrent())" />
                <RadzenButton Text="Download .eml" Icon="download" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Click="@(_ => DownloadCurrent())" />
            }
        </div>
        <div style="flex:1 1 auto; min-height:0; overflow:auto; padding-right:4px;">
            @if (_isLoadingContent)
            {
                <div class="rz-p-3"><em>Loading content...</em></div>
            }
            else if (_currentEmail is null)
            {
                <div class="rz-text-muted" style="text-align:center; margin-top:3rem; font-size:1.2rem;">Select a message to view its details.</div>
            }
            else
            {
                <div class="rz-p-2" style="max-width:100%;">
                    <p><strong>Subject:</strong> @DisplaySubject(_currentEmail.Metadata.Subject)</p>
                    <p><strong>From:</strong> @_currentEmail.Metadata.From</p>
                    <p><strong>Received:</strong> @_currentEmail.Metadata.Received.ToLocalTime()</p>
                    <p><strong>Recipient User:</strong> @_currentEmail.Metadata.RecipientUser</p>
                    <hr />
                    @if (_isHtmlBody && !string.IsNullOrEmpty(_currentBody))
                    {
                        <iframe srcdoc="@_currentBody" 
                                style="width:100%; height:500px; border:1px solid #ccc; background:#fff;" 
                                sandbox="allow-same-origin" 
                                title="Email content">
                        </iframe>
                    }
                    else
                    {
                        <pre style="white-space:pre-wrap; font-size:0.82rem; line-height:1.15rem;">@_currentBody</pre>
                    }
                </div>
            }
        </div>
    </RadzenColumn>
</RadzenRow>

@code {
    private List<string>? _recipientFolders;
    private string? _selectedRecipient;
    private List<EmailListItem>? _messages;
    private EmailMessage? _currentEmail;
    private string? _selectedMessageId;
    private bool _isLoadingMessages;
    private bool _isLoadingContent;

    // SMTP settings from table
    private bool _settingsLoaded;
    private string? _settingsError;
    private string? _allowedRecipient;

    private string? _currentBody;
    private bool _isHtmlBody;

    private string DisplaySubject(string? subject) => string.IsNullOrWhiteSpace(subject) ? "(no subject)" : subject!;

    protected override async Task OnInitializedAsync()
    {
        // Load settings first so we can augment folders with standard mailboxes
        await LoadSmtpSettingsAsync();

        var folders = (await EmailService.GetRecipientFoldersAsync()).ToList();
        _recipientFolders = EnsureDefaultMailboxes(folders);

        // Prefer selecting the configured user's folder if available, otherwise keep current selection or pick first
        var configuredUser = GetUserFromEmail(_allowedRecipient);
        if (!string.IsNullOrWhiteSpace(configuredUser) && _recipientFolders.Contains(configuredUser, StringComparer.OrdinalIgnoreCase))
        {
            SelectRecipient(configuredUser);
        }
        else if (!string.IsNullOrWhiteSpace(_selectedRecipient))
        {
            SelectRecipient(_selectedRecipient.ToLower());
        }
        else if (_recipientFolders.Count > 0)
        {
            SelectRecipient(_recipientFolders[0]);
        }
    }

    private static string? GetUserFromEmail(string? email)
    {
        if (string.IsNullOrWhiteSpace(email)) return null;
        var at = email.IndexOf('@');
        return at > 0 ? email[..at] : email;
    }

    private List<string> EnsureDefaultMailboxes(IEnumerable<string> existing)
    {
        var set = new HashSet<string>(existing ?? Enumerable.Empty<string>(), StringComparer.OrdinalIgnoreCase);

        // Always include role accounts
        set.Add("abuse");
        set.Add("postmaster");
        set.Add("spam");

        // Include configured recipient local-part if present
        var configuredUser = GetUserFromEmail(_allowedRecipient.ToLower());
        if (!string.IsNullOrWhiteSpace(configuredUser)) set.Add(configuredUser);
        return set.OrderBy(s => s, StringComparer.OrdinalIgnoreCase).ToList();
    }

    private async Task LoadSmtpSettingsAsync()
    {
        try
        {
            var configAllowed = Configuration["SmtpServer:AllowedRecipient"];
            if (!string.IsNullOrWhiteSpace(configAllowed))
            {
                _allowedRecipient = configAllowed.ToLower();
                var configServer = Configuration["SmtpServer:ServerName"];
                if (!_allowedRecipient.Contains('@') && !string.IsNullOrWhiteSpace(configServer))
                {
                    _allowedRecipient = $"{_allowedRecipient}@{configServer}";
                }
                _settingsLoaded = true;
                _settingsError = null;
                return;
            }

            var table = TableServiceClient.GetTableClient("SMTPSettings");
            var resp = await table.GetEntityIfExistsAsync<TableEntity>("SmtpServer", "Current");
            if (resp.HasValue)
            {
                var entity = resp.Value;
                if (entity != null)
                {
                    _allowedRecipient = entity.TryGetValue("AllowedRecipient", out var v) ? v?.ToString() : null;
                    string? ServerName = entity.TryGetValue("ServerName", out var x) ? x?.ToString() : "";

                    _allowedRecipient = $"{_allowedRecipient}@{ServerName}";
                }
                else
                {
                    _allowedRecipient = "";
                }
                _settingsLoaded = true;
                _settingsError = null;
            }
            else
            {
                _settingsLoaded = false;
                _settingsError = "SMTP settings were not found.";
            }
        }
        catch (Exception ex)
        {
            _settingsLoaded = false;
            _settingsError = $"Failed to load SMTP settings: {ex.Message}";
        }
    }

    private void OnRecipientChanged(object? value)
    {
        var folder = value as string;
        if (!string.IsNullOrWhiteSpace(folder))
        {
            SelectRecipient(folder);
        }
    }

    private async void SelectRecipient(string folder)
    {
        _selectedRecipient = folder;
        _messages = null;
        _currentEmail = null;
        _currentBody = null;
        _selectedMessageId = null;
        _isLoadingMessages = true;
        StateHasChanged();
        try
        {
            _messages = (await EmailService.ListEmailsAsync(folder)).ToList();
        }
        finally
        {
            _isLoadingMessages = false;
            StateHasChanged();
        }
    }

    private void OnMessageChanged(object? value)
    {
        var id = value?.ToString();
        if (!string.IsNullOrWhiteSpace(id))
        {
            OpenMessage(id);
        }
    }

    private async void OpenMessage(string id)
    {
        _selectedMessageId = id;
        _currentEmail = null;
        _currentBody = null;
        _isHtmlBody = false;
        _isLoadingContent = true;
        StateHasChanged();
        try
        {
            _currentEmail = await EmailService.GetEmailAsync(id);
            if (_currentEmail is not null)
            {
                (_currentBody, _isHtmlBody) = ExtractBodyWithMimeKit(_currentEmail.RawEml);
            }
        }
        finally
        {
            _isLoadingContent = false;
            StateHasChanged();
        }
    }

    private static (string Body, bool IsHtml) ExtractBodyWithMimeKit(string raw)
    {
        if (string.IsNullOrEmpty(raw)) 
            return (string.Empty, false);

        try
        {
            // Skip custom X-SMTP-Server headers to get to the actual RFC822 message
            var normalizedRaw = raw.Replace("\r\n", "\n");
            var headerEnd = normalizedRaw.IndexOf("\n\n");
            string emlContent = raw;
            
            if (headerEnd > 0)
            {
                // Check if there's a second header block (custom headers followed by real headers)
                var afterFirst = headerEnd + 2;
                var firstLineAfter = normalizedRaw.Substring(afterFirst).Split('\n').FirstOrDefault() ?? "";
                
                // If the line after first blank looks like a header (contains ':'), we have custom headers
                if (firstLineAfter.Contains(':') && !firstLineAfter.StartsWith(" ") && !firstLineAfter.StartsWith("\t"))
                {
                    // Use content starting from after custom headers
                    emlContent = raw.Substring(raw.IndexOf("\r\n\r\n") + 4);
                    if (emlContent == raw) // fallback if \r\n\r\n not found
                        emlContent = raw.Substring(headerEnd + 2);
                }
            }

            using var stream = new MemoryStream(System.Text.Encoding.UTF8.GetBytes(emlContent));
            var message = MimeMessage.Load(stream);

            // Build a dictionary of Content-ID to data URL for embedded images
            var cidMap = BuildCidMap(message);

            // Prefer HTML body if available
            if (!string.IsNullOrEmpty(message.HtmlBody))
            {
                var html = ReplaceCidReferences(message.HtmlBody, cidMap);
                return (html, true);
            }

            // Fall back to text body
            if (!string.IsNullOrEmpty(message.TextBody))
            {
                return (message.TextBody, false);
            }

            // If no body parts found, try to get content from body parts directly
            var htmlPart = message.BodyParts.OfType<TextPart>().FirstOrDefault(p => p.IsHtml);
            if (htmlPart != null)
            {
                var html = ReplaceCidReferences(htmlPart.Text, cidMap);
                return (html, true);
            }

            var textPart = message.BodyParts.OfType<TextPart>().FirstOrDefault();
            if (textPart != null)
            {
                return (textPart.Text, false);
            }

            return ("(No readable content)", false);
        }
        catch (Exception ex)
        {
            // If MimeKit parsing fails, fall back to simple extraction
            return (FallbackExtractBody(raw) + $"\n\n[Parse error: {ex.Message}]", false);
        }
    }

    private static string FallbackExtractBody(string raw)
    {
        if (string.IsNullOrEmpty(raw)) return string.Empty;
        var text = raw.Replace("\r\n", "\n");
        var first = text.IndexOf("\n\n");
        if (first < 0) return raw;
        var afterFirst = first + 2;
        var second = text.IndexOf("\n\n", afterFirst);
        if (second < 0)
            return text.Substring(afterFirst);
        return text.Substring(second + 2);
    }

    /// <summary>
    /// Builds a dictionary mapping Content-ID values to data URLs for embedded images.
    /// </summary>
    private static Dictionary<string, string> BuildCidMap(MimeMessage message)
    {
        var cidMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

        foreach (var bodyPart in message.BodyParts)
        {
            if (bodyPart is MimePart mimePart && !string.IsNullOrEmpty(mimePart.ContentId))
            {
                // Get the Content-ID without angle brackets
                var contentId = mimePart.ContentId.Trim('<', '>');
                
                // Only process image types
                if (mimePart.ContentType.MediaType.Equals("image", StringComparison.OrdinalIgnoreCase))
                {
                    try
                    {
                        using var memoryStream = new MemoryStream();
                        mimePart.Content.DecodeTo(memoryStream);
                        var base64 = Convert.ToBase64String(memoryStream.ToArray());
                        var mimeType = mimePart.ContentType.MimeType;
                        var dataUrl = $"data:{mimeType};base64,{base64}";
                        cidMap[contentId] = dataUrl;
                    }
                    catch
                    {
                        // Skip if we can't decode the image
                    }
                }
            }
        }

        return cidMap;
    }

    /// <summary>
    /// Replaces cid: references in HTML with data URLs from the CID map.
    /// </summary>
    private static string ReplaceCidReferences(string html, Dictionary<string, string> cidMap)
    {
        if (string.IsNullOrEmpty(html) || cidMap.Count == 0)
            return html;

        // Replace cid: references with data URLs
        // Pattern matches src="cid:..." or src='cid:...'
        foreach (var kvp in cidMap)
        {
            // Handle various formats: cid:contentId or cid:contentId@domain
            html = html.Replace($"cid:{kvp.Key}", kvp.Value, StringComparison.OrdinalIgnoreCase);
        }

        return html;
    }

    private static string? GetHeader(string raw, string headerName)
    {
        if (string.IsNullOrEmpty(raw)) return null;
        using var reader = new StringReader(raw);
        string? line;
        var prefix = headerName + ":";
        var blankSeen = 0;
        while ((line = reader.ReadLine()) != null)
        {
            if (string.IsNullOrWhiteSpace(line))
            {
                blankSeen++;
                if (blankSeen > 2) break; // don't scan into body
                continue;
            }
            if (line.StartsWith(prefix, StringComparison.OrdinalIgnoreCase))
            {
                return line.Substring(prefix.Length).Trim();
            }
        }
        return null;
    }

    private async void ReplyToCurrent()
    {
        if (_currentEmail is null) return;

        var originalFrom = GetHeader(_currentEmail.RawEml, "From") ?? _currentEmail.Metadata.From;
        var originalTo = GetHeader(_currentEmail.RawEml, "To") ?? _allowedRecipient ?? _currentEmail.Metadata.RecipientUser + "@example.com";
        var originalSubject = _currentEmail.Metadata.Subject;
        var subject = !string.IsNullOrWhiteSpace(originalSubject) && !originalSubject.StartsWith("re:", StringComparison.OrdinalIgnoreCase)
            ? "re: " + originalSubject
            : originalSubject;

        // Parse "Date" header to a friendly local string if possible
        var dateHeader = GetHeader(_currentEmail.RawEml, "Date");
        string sentDisplay;
        if (DateTimeOffset.TryParse(dateHeader, out var sentDto))
        {
            sentDisplay = sentDto.ToLocalTime().ToString("f", CultureInfo.CurrentCulture);
        }
        else
        {
            sentDisplay = _currentEmail.Metadata.Received.ToLocalTime().ToString("f", CultureInfo.CurrentCulture);
        }

        var quotedHeader = $"From: {originalFrom}\nSent: {sentDisplay}\nTo: {originalTo}\nSubject: {originalSubject}";
        var (extractedBody, _) = ExtractBodyWithMimeKit(_currentEmail.RawEml);
        var originalBody = _currentBody ?? extractedBody;
        var defaultBody = "\n\n-----Original Message-----\n" + quotedHeader + "\n\n" + originalBody;

        var result = await DialogService.OpenAsync<ComposeEmailDialog>(
            "Reply",
            new Dictionary<string, object?>
            {
                ["DefaultTo"] = originalFrom,
                ["DefaultFrom"] = originalTo,
                ["DefaultSubject"] = subject,
                ["DefaultBody"] = defaultBody
            },
            new DialogOptions { Width = "700px", CloseDialogOnOverlayClick = false }
        );

        if (result is bool b && b)
        {
            await RefreshMessagesAsync();
        }
    }

    private void DownloadCurrent()
    {
        if (_currentEmail is null) return;
        var bytes = System.Text.Encoding.UTF8.GetBytes(_currentEmail.RawEml);
        var base64 = Convert.ToBase64String(bytes);
        var fileName = _currentEmail.Metadata.BlobName.Split('/').Last();
        var url = $"data:text/plain;base64,{base64}";
        JSRuntime.InvokeVoidAsync("eval", $"(function(){{var a=document.createElement('a');a.href='{url}';a.download='{fileName}';a.click();}})();");
    }

    private async Task ConfirmDeleteAsync(EmailListItem item)
    {
        var confirmed = await DialogService.Confirm($"Delete message '{DisplaySubject(item.Subject)}' from '{item.From}'?", "Confirm Delete", new ConfirmOptions() { OkButtonText = "Delete", CancelButtonText = "Cancel", CloseDialogOnOverlayClick = true });
        if (confirmed == true)
        {
            var ok = await EmailService.DeleteEmailAsync(item.BlobName);
            if (ok)
            {
                // Refresh list; if the deleted item was selected, clear the preview
                await RefreshMessagesAsync();
                if (_currentEmail?.Metadata.BlobName == item.BlobName)
                {
                    _currentEmail = null;
                    _currentBody = null;
                    _selectedMessageId = null;
                    StateHasChanged();
                }
            }
        }
    }

    private async Task RefreshMessagesAsync()
    {
        if (string.IsNullOrWhiteSpace(_selectedRecipient)) return;
        _isLoadingMessages = true;
        StateHasChanged();
        try
        {
            _messages = (await EmailService.ListEmailsAsync(_selectedRecipient!)).ToList();
        }
        finally
        {
            _isLoadingMessages = false;
            StateHasChanged();
        }
    }

    private async Task NewMessageClick()
    {
        if (!_settingsLoaded || string.IsNullOrWhiteSpace(_allowedRecipient))
        {
            await DialogService.OpenAsync("SMTP Settings Missing", ds => builder =>
            {
                builder.OpenElement(0, "div");
                builder.AddAttribute(1, "class", "rz-p-3");
                builder.AddContent(2, _settingsError ?? "SMTP settings were not found.");
                builder.CloseElement();
            }, new DialogOptions { Width = "500px" });
            return;
        }

        var result = await DialogService.OpenAsync<ComposeEmailDialog>(
            "New message",
            new Dictionary<string, object?>
            {
                ["DefaultTo"] = _allowedRecipient
            },
            new DialogOptions { Width = "700px", CloseDialogOnOverlayClick = false }
        );

        if (result is bool b && b)
        {
            // Refresh folders and select recipient folder of the AllowedRecipient (local-part)
            var user = GetUserFromEmail(_allowedRecipient!) ?? _allowedRecipient!;
            _recipientFolders = EnsureDefaultMailboxes(await EmailService.GetRecipientFoldersAsync());
            if (_recipientFolders.Contains(user, StringComparer.OrdinalIgnoreCase))
            {
                SelectRecipient(user);
            }
            else if (_recipientFolders.Count > 0)
            {
                SelectRecipient(_recipientFolders[0]);
            }
        }
    }
}

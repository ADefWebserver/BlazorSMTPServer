@page "/"
@using BlazorSMTPServer.Services
@using Azure.Data.Tables
@using BlazorSMTPServer.Components.Dialogs
@inject BlobEmailService EmailService
@inject Microsoft.JSInterop.IJSRuntime JSRuntime
@inject Radzen.DialogService DialogService
@inject TableServiceClient TableServiceClient

<PageTitle>Inbox</PageTitle>

<!-- Two-column mail layout -->
<RadzenRow Style="height:calc(100vh - 40px);">
    <!-- Left column: compose + recipient + messages -->
    <RadzenColumn Size="3" Style="height:100%; display:flex; flex-direction:column; gap:10px;">
        <RadzenButton Text="New message" Icon="play_arrow" ButtonStyle="ButtonStyle.Success" Style="width:100%;" Click="@NewMessageClick" />

        <!-- Recipient list -->
        <div style="display:flex; flex-direction:column; flex:1 1 auto; min-height:0;">
            @if (_recipientFolders is null)
            {
                <div class="rz-p-2"><em>Loading folders...</em></div>
            }
            else if (_recipientFolders.Count == 0)
            {
                <div class="rz-p-2 text-muted">No recipient folders found.</div>
            }
            else
            {
                <RadzenListBox Data="@_recipientFolders"
                               @bind-Value="_selectedRecipient"
                               Change="@OnRecipientChanged"
                               Style="margin-bottom:10px;" Filterable="false">
                    <Template Context="folder">
                        <div class="rz-d-flex rz-align-items-center">
                            <RadzenIcon Icon="mail" Class="rz-mr-2" />
                            <span>@folder</span>
                        </div>
                    </Template>
                </RadzenListBox>

                <!-- Messages list -->
                @if (_isLoadingMessages)
                {
                    <div class="rz-p-2"><em>Loading messages...</em></div>
                }
                else if (_messages is null || _messages.Count == 0)
                {
                    <div class="rz-p-2 rz-text-muted" style="text-align:center;">Empty list.</div>
                }
                else
                {
                    <RadzenListBox Data="@_messages" ValueProperty="Id" @bind-Value="_selectedMessageId" Change="@OnMessageChanged"
                                   Style="flex:1 1 auto; min-height:0; overflow:auto;">
                        <Template Context="m">
                            <div style="padding:4px 4px;">
                                <div style="font-weight:600;" class="rz-truncate" title="@DisplaySubject(m.Subject)">@DisplaySubject(m.Subject)</div>
                                <small class="rz-text-secondary">From:</small>
                                <div class="rz-truncate" title="@m.From">@m.From</div>
                            </div>
                        </Template>
                    </RadzenListBox>
                }
            }
        </div>
    </RadzenColumn>

    <!-- Right column: preview -->
    <RadzenColumn Size="9" Style="height:100%; min-width:0; display:flex; flex-direction:column;">
        <!-- Download button row (search removed) -->
        <div class="rz-d-flex rz-align-items-center" style="gap:12px; padding:4px 0;">
            @if (_currentEmail is not null)
            {
                <RadzenButton Text="Download .eml" Icon="download" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Click="@(_ => DownloadCurrent())" />
            }
        </div>
        <div style="flex:1 1 auto; min-height:0; overflow:auto; padding-right:4px;">
            @if (_isLoadingContent)
            {
                <div class="rz-p-3"><em>Loading content...</em></div>
            }
            else if (_currentEmail is null)
            {
                <div class="rz-text-muted" style="text-align:center; margin-top:3rem; font-size:1.2rem;">Select a message to view its details.</div>
            }
            else
            {
                <div class="rz-p-2" style="max-width:100%;">
                    <p><strong>Subject:</strong> @DisplaySubject(_currentEmail.Metadata.Subject)</p>
                    <p><strong>From:</strong> @_currentEmail.Metadata.From</p>
                    <p><strong>Received:</strong> @_currentEmail.Metadata.Received.ToLocalTime()</p>
                    <p><strong>Recipient User:</strong> @_currentEmail.Metadata.RecipientUser</p>
                    <hr />
                    <pre style="white-space:pre-wrap; font-size:0.82rem; line-height:1.15rem;">@_currentEmail.RawEml</pre>
                </div>
            }
        </div>
    </RadzenColumn>
</RadzenRow>

@code {
    private List<string>? _recipientFolders;
    private string? _selectedRecipient;
    private List<EmailListItem>? _messages;
    private EmailMessage? _currentEmail;
    private string? _selectedMessageId;
    private bool _isLoadingMessages;
    private bool _isLoadingContent;

    // SMTP settings from table
    private bool _settingsLoaded;
    private string? _settingsError;
    private string? _allowedRecipient;

    private string DisplaySubject(string? subject) => string.IsNullOrWhiteSpace(subject) ? "(no subject)" : subject!;

    protected override async Task OnInitializedAsync()
    {
        // Load folders and settings in sequence
        _recipientFolders = (await EmailService.GetRecipientFoldersAsync()).ToList();
        await LoadSmtpSettingsAsync();
        if (_recipientFolders.Count == 1)
        {
            SelectRecipient(_recipientFolders[0]);
        }
    }

    private async Task LoadSmtpSettingsAsync()
    {
        try
        {
            var table = TableServiceClient.GetTableClient("SMTPSettings");
            var resp = await table.GetEntityIfExistsAsync<TableEntity>("SmtpServer", "Current");
            if (resp.HasValue)
            {
                var entity = resp.Value;
                _allowedRecipient = entity.TryGetValue("AllowedRecipient", out var v) ? v?.ToString() : null;
                _settingsLoaded = true;
                _settingsError = null;
            }
            else
            {
                _settingsLoaded = false;
                _settingsError = "SMTP settings were not found.";
            }
        }
        catch (Exception ex)
        {
            _settingsLoaded = false;
            _settingsError = $"Failed to load SMTP settings: {ex.Message}";
        }
    }

    private void OnRecipientChanged(object? value)
    {
        var folder = value as string;
        if (!string.IsNullOrWhiteSpace(folder))
        {
            SelectRecipient(folder);
        }
    }

    private async void SelectRecipient(string folder)
    {
        _selectedRecipient = folder;
        _messages = null;
        _currentEmail = null;
        _selectedMessageId = null;
        _isLoadingMessages = true;
        StateHasChanged();
        try
        {
            _messages = (await EmailService.ListEmailsAsync(folder)).ToList();
        }
        finally
        {
            _isLoadingMessages = false;
            StateHasChanged();
        }
    }

    private void OnMessageChanged(object? value)
    {
        var id = value?.ToString();
        if (!string.IsNullOrWhiteSpace(id))
        {
            OpenMessage(id);
        }
    }

    private async void OpenMessage(string id)
    {
        _selectedMessageId = id;
        _currentEmail = null;
        _isLoadingContent = true;
        StateHasChanged();
        try
        {
            _currentEmail = await EmailService.GetEmailAsync(id);
        }
        finally
        {
            _isLoadingContent = false;
            StateHasChanged();
        }
    }

    private void DownloadCurrent()
    {
        if (_currentEmail is null) return;
        var bytes = System.Text.Encoding.UTF8.GetBytes(_currentEmail.RawEml);
        var base64 = Convert.ToBase64String(bytes);
        var fileName = _currentEmail.Metadata.BlobName.Split('/').Last();
        var url = $"data:text/plain;base64,{base64}";
        JSRuntime.InvokeVoidAsync("eval", $"(function(){{var a=document.createElement('a');a.href='{url}';a.download='{fileName}';a.click();}})();");
    }

    private async Task NewMessageClick()
    {
        if (!_settingsLoaded || string.IsNullOrWhiteSpace(_allowedRecipient))
        {
            await DialogService.OpenAsync("SMTP Settings Missing", ds => builder =>
            {
                builder.OpenElement(0, "div");
                builder.AddAttribute(1, "class", "rz-p-3");
                builder.AddContent(2, _settingsError ?? "SMTP settings were not found.");
                builder.CloseElement();
            }, new DialogOptions { Width = "500px" });
            return;
        }

        var result = await DialogService.OpenAsync<ComposeEmailDialog>(
            "New message",
            new Dictionary<string, object?>
            {
                ["DefaultTo"] = _allowedRecipient
            },
            new DialogOptions { Width = "700px", CloseDialogOnOverlayClick = false }
        );

        if (result is bool b && b)
        {
            // Refresh folders and select recipient folder of the AllowedRecipient (local-part)
            var user = _allowedRecipient!.Split('@')[0];
            _recipientFolders = (await EmailService.GetRecipientFoldersAsync()).ToList();
            if (_recipientFolders.Contains(user, StringComparer.OrdinalIgnoreCase))
            {
                SelectRecipient(user);
            }
            else if (_recipientFolders.Count > 0)
            {
                SelectRecipient(_recipientFolders[0]);
            }
        }
    }
}

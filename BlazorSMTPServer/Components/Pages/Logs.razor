@page "/logs"
@using Azure.Data.Tables
@using Microsoft.JSInterop
@inject TableServiceClient TableServiceClient
@inject IJSRuntime JS

<PageTitle>Logs</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="10px">
    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenTextBox @bind-Value="_search" Placeholder="Search logs (level, category, message)" Style="width: 320px" Change="@(args => ApplySearch())">
                <RadzenIcon Icon="search" Style="margin-right:6px" />
            </RadzenTextBox>
            <RadzenButton Text="Refresh" Icon="refresh" Click="Reload" Style="margin-left:10px" Disabled="@_loading" />
            @if (_loading)
            {
                <span class="rz-ml-2">Loading...</span>
            }
            @if (!string.IsNullOrEmpty(_error))
            {
                <RadzenAlert Severity="AlertSeverity.Error" Style="margin-left:10px; display:inline-block">@_error</RadzenAlert>
            }
        </RadzenColumn>
    </RadzenRow>

    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenDataGrid TItem="LogView"
                            Data="@_filtered"
                            AllowPaging="true"
                            PageSize="50"
                            AllowSorting="true"
                            AllowFiltering="false"
                            AllowColumnResize="true"
                            RowHover="true"
                            Style="height: calc(100vh - 180px);">
                <Columns>
                    <RadzenDataGridColumn TItem="LogView" Title="Timestamp" Width="220px">
                        <Template Context="item">
                            @FormatLocal(item.Timestamp)
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="LogView" Property="Category" Title="Category" Width="320px" />
                    <RadzenDataGridColumn TItem="LogView" Property="Message" Title="Message" />
                </Columns>
            </RadzenDataGrid>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

<!-- Sentinel used for infinite scroll trigger -->
<div style="height:1px" @ref="_sentinel"></div>

@code {
    private List<LogView> _all = new();
    private List<LogView> _filtered = new();
    private bool _loading;
    private string? _error;
    private string _search = string.Empty;

    // Paging via continuation token
    private string? _continuationToken;
    private bool _hasMore;
    private readonly int _pageSize = 200;

    private ElementReference _sentinel;
    private DotNetObjectReference<Logs>? _dotNetRef; // Keep reference alive for JS callbacks

    // Browser timezone offset in minutes (UTC - Local). If null, we haven't detected yet.
    private int? _tzOffsetMinutes;

    protected override async Task OnInitializedAsync()
    {
        await ResetAndInitialLoadAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            try
            {
                await JS.InvokeVoidAsync("infiniteScroll.observe", _sentinel, _dotNetRef);
            }
            catch
            {
                // If the script isn't loaded yet, ignore silently
            }

            // Get browser timezone offset once and re-render to show local times
            try
            {
                _tzOffsetMinutes = await JS.InvokeAsync<int>("blazorTime.getTimezoneOffsetMinutes");
                StateHasChanged();
            }
            catch { /* optional: ignore if script not available */ }
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("infiniteScroll.disconnect", _sentinel);
        }
        catch { }
        _dotNetRef?.Dispose();
    }

    [JSInvokable]
    public async Task OnInfiniteScroll()
    {
        if (_loading || !_hasMore) return;
        await LoadNextPageAsync();
    }

    private async Task ResetAndInitialLoadAsync()
    {
        _continuationToken = null;
        _hasMore = true;
        _all.Clear();
        _filtered.Clear();
        await LoadNextPageAsync();
    }

    private async Task LoadNextPageAsync()
    {
        _loading = true;
        _error = null;
        StateHasChanged();
        try
        {
            var table = TableServiceClient.GetTableClient("SMTPServerLogs");

            // Read a single page using the current continuation token
            await foreach (var page in table.QueryAsync<TableEntity>().AsPages(_continuationToken, _pageSize))
            {
                foreach (var entity in page.Values)
                {
                    var view = new LogView
                    {
                        PartitionKey = entity.PartitionKey,
                        RowKey = entity.RowKey,
                        Timestamp = ExtractTimestamp(entity),
                        LogLevel = entity.TryGetValue("LogLevel", out var lvl) ? lvl?.ToString() ?? string.Empty : string.Empty,
                        Category = entity.TryGetValue("Category", out var cat) ? cat?.ToString() ?? string.Empty : string.Empty,
                        EventId = entity.TryGetValue("EventId", out var eid) && int.TryParse(eid?.ToString(), out var id) ? id : 0,
                        EventName = entity.TryGetValue("EventName", out var en) ? en?.ToString() ?? string.Empty : string.Empty,
                        Message = entity.TryGetValue("Message", out var msg) ? msg?.ToString() ?? string.Empty : string.Empty,
                        Exception = entity.TryGetValue("Exception", out var ex) ? ex?.ToString() ?? string.Empty : string.Empty,
                    };
                    _all.Add(view);
                }

                _continuationToken = page.ContinuationToken;
                _hasMore = !string.IsNullOrEmpty(_continuationToken);

                // Take only the first page in this invocation
                break;
            }

            // Most recent first
            _all = _all.OrderByDescending(l => l.Timestamp).ToList();
            ApplySearch();
        }
        catch (Exception ex)
        {
            _error = $"Failed to load logs: {ex.Message}";
            _hasMore = false;
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private static DateTime ExtractTimestamp(TableEntity entity)
    {
        try
        {
            if (entity.TryGetValue("Timestamp", out var tsObj) && tsObj is not null)
            {
                if (tsObj is DateTime dt) return dt.ToUniversalTime();
                if (tsObj is DateTimeOffset dto) return dto.UtcDateTime;
                if (DateTime.TryParse(tsObj.ToString(), out var parsed)) return parsed.ToUniversalTime();
            }
        }
        catch { }
        return entity.Timestamp?.UtcDateTime ?? DateTime.MinValue;
    }

    private void ApplySearch()
    {
        var s = _search?.Trim();
        if (string.IsNullOrEmpty(s))
        {
            _filtered = _all.ToList();
        }
        else
        {
            var term = s.ToLowerInvariant();
            _filtered = _all.Where(l =>
                (l.LogLevel?.ToLowerInvariant().Contains(term) ?? false) ||
                (l.Category?.ToLowerInvariant().Contains(term) ?? false) ||
                (l.Message?.ToLowerInvariant().Contains(term) ?? false) ||
                (l.Exception?.ToLowerInvariant().Contains(term) ?? false) ||
                (l.EventName?.ToLowerInvariant().Contains(term) ?? false) ||
                l.EventId.ToString().Contains(term) ||
                (l.PartitionKey?.ToLowerInvariant().Contains(term) ?? false) ||
                (l.RowKey?.ToLowerInvariant().Contains(term) ?? false)
            ).ToList();
        }
    }

    private async Task Reload()
    {
        await ResetAndInitialLoadAsync();
    }

    private static string Truncate(string value, int max)
        => string.IsNullOrEmpty(value) || value.Length <= max ? value : value.Substring(0, max) + "…";

    private string FormatLocal(DateTime utc)
    {
        // Ensure UTC kind for consistent conversion
        var dt = DateTime.SpecifyKind(utc, DateTimeKind.Utc);
        if (_tzOffsetMinutes is int minutes)
        {
            // getTimezoneOffset returns minutes between UTC and local time (UTC - Local)
            // Local = UTC - offset
            var local = dt.AddMinutes(-minutes);
            return local.ToString("yyyy-MM-dd HH:mm:ss.fff");
        }
        // Fallback to UTC display until we detect browser offset
        return dt.ToString("yyyy-MM-dd HH:mm:ss.fff 'UTC'");
    }

    public class LogView
    {
        public string? PartitionKey { get; set; }
        public string? RowKey { get; set; }
        public DateTime Timestamp { get; set; }
        public string? LogLevel { get; set; }
        public string? Category { get; set; }
        public int EventId { get; set; }
        public string? EventName { get; set; }
        public string? Message { get; set; }
        public string? Exception { get; set; }
    }
}

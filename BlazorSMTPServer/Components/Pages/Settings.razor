@page "/settings"
@using Azure.Data.Tables
@using System.Text.Json
@using System.Text.Json.Nodes
@using BlazorSMTPServer.Classes
@using Nager.Dns
@using Nager.Dns.Models
@using Org.BouncyCastle.Crypto
@using Org.BouncyCastle.OpenSsl
@using Org.BouncyCastle.Security
@using Org.BouncyCastle.Crypto.Generators
@using System.IO
@inject TableServiceClient Tables
@inject ILogger<Settings> Log
@inject IConfiguration Config
@inject IWebHostEnvironment Env
@inject DialogService DialogService
@inject IHttpClientFactory HttpClientFactory

<div>
    <h1 class="h3 mb-0">Settings</h1>
    <br />
    <RadzenTabs RenderMode="TabRenderMode.Client">
        <Tabs>
            <RadzenTabsItem Text="General">
                <div class="mb-3">
                    <RadzenButton Text="Test Server" Click="@OpenTestServerDialog" ButtonStyle="ButtonStyle.Info" />
                </div>
                <div class="row">
                    <div class="p-3">
                        <div class="card shadow-sm mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-3">Server Configuration (configured in appsettings.json)</h5>
                                @if (IsLoading)
                                {
                                    <div class="text-center p-3">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                }
                                else if (Error != null)
                                {
                                    <div class="alert alert-danger">@Error</div>
                                    <button class="btn btn-outline-primary" @onclick="LoadAsync">Retry</button>
                                }
                                else
                                {
                                    @if (Saved)
                                    {
                                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                                            Settings saved successfully.
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"
                                                    aria-label="Close"></button>
                                        </div>
                                    }

                                <form @onsubmit="SaveAsync">
                                    <div class="row g-3">
                                        <div class="col-12 col-md-6">
                                            <label class="form-label">Server Name</label>
                                            <input class="form-control" value="@ServerName" readonly disabled />
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <label class="form-label">Ports</label>
                                            <input class="form-control" value="@Ports" readonly disabled />
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Allowed Recipient (Primary)</label>
                                            <input class="form-control" value="@AllowedRecipient" readonly disabled />
                                        </div>

                                        <div class="col-12 col-md-6">
                                            <label class="form-label">Auth Username</label>
                                            <input class="form-control" value="@AllowedUsername" readonly disabled />
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <label class="form-label">Auth Password</label>
                                            <div class="input-group">
                                                <input class="form-control"
                                                       type="@(ShowAllowedPassword ? "text" : "password")"
                                                       value="@AllowedPassword" readonly disabled />
                                                <button class="btn btn-outline-secondary" type="button"
                                                        @onclick="() => ShowAllowedPassword = !ShowAllowedPassword">
                                                    @(ShowAllowedPassword
                                                                                                        ? "Hide" : "Show")
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="col-12">
                                                <hr />
                                            </div>

                                            <div class="col-12 col-md-6">
                                                <label class="form-label" for="appPassword">App Password</label>
                                                <div class="input-group">
                                                    <input id="appPassword" class="form-control" autocomplete="new-password"
                                                           type="@(ShowAppPassword ? "text" : "password")"
                                                           placeholder="Enter password to protect this UI"
                                                           @bind="AppPassword" />
                                                    <button class="btn btn-outline-secondary" type="button"
                                                            @onclick="() => ShowAppPassword = !ShowAppPassword">
                                                        @(ShowAppPassword
                                                                                                            ? "Hide" : "Show")
                                                    </button>
                                                </div>
                                                <div class="form-text mb-3">
                                                    Protects access to this UI. Blank means open
                                                    access. (Stored in appsettings.json)
                                                </div>
                                                <div class="d-flex align-items-center gap-2">
                                                    <button type="submit" class="btn btn-primary"
                                                            disabled="@(Saving || IsLoading)">
                                                        @if (Saving)
                                                        {
                                                            <span class="spinner-border spinner-border-sm me-2" role="status"
                                                                  aria-hidden="true"></span>
                                                        }
                                                        Save
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary"
                                                            @onclick="ResetAsync"
                                                            disabled="@(Saving || IsLoading)">
                                                        Reset
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </RadzenTabsItem>

            <RadzenTabsItem Text="DNS">
                <div class="p-3">
                    <div class="alert alert-info">
                        See this <a href="https://smartreach.io/blog/how-to-set-up-spf-dkim-dmarc-guide/" target="_blank">guide</a> as to what you need to do to configure the DNS settings for your email server.
                    </div>
                    <div class="alert alert-warning">
                        After making changes to your DNS records, it may take some time for the changes to propagate. Use the verification buttons below to check if the records are correctly set up.
                    </div>
                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <details>
                                <summary class="h5 card-title mb-3" style="cursor: pointer">MX Record</summary>
                                <p>Proper Value: <code>10 @ServerName</code></p>
                                <RadzenButton Text="Verify MX Record" Click="@VerifyMX" IsBusy="@IsVerifyingMX" />
                                @if (MxResult != null)
                                {
                                    <div class="mt-2 alert @(MxSuccess ? "alert-success" : "alert-warning")">
                                        @MxResult
                                    </div>
                                }
                            </details>
                        </div>
                    </div>

                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <details>
                                <summary class="h5 card-title mb-3" style="cursor: pointer">SPF Record</summary>
                                <p>Proper Value: <code>v=spf1 mx a:@ServerName -all</code></p>
                                <RadzenButton Text="Verify SPF" Click="@VerifySPF" IsBusy="@IsVerifyingSPF" />
                                @if (SpfResult != null)
                                {
                                    <div class="mt-2 alert @(SpfSuccess ? "alert-success" : "alert-warning")">
                                        @SpfResult
                                    </div>
                                }
                            </details>
                        </div>
                    </div>

                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <details>
                                <summary class="h5 card-title mb-3" style="cursor: pointer">DMARC Record</summary>
                                <p>Proper Value: <code>v=DMARC1; p=none; rua=mailto:postmaster@@@ServerName</code></p>
                                <RadzenButton Text="Verify DMARC" Click="@VerifyDMARC" IsBusy="@IsVerifyingDMARC" />
                                @if (DmarcResult != null)
                                {
                                    <div class="mt-2 alert @(DmarcSuccess ? "alert-success" : "alert-warning")">
                                        @DmarcResult
                                    </div>
                                }
                            </details>
                        </div>
                    </div>

                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <details>
                                <summary class="h5 card-title mb-3" style="cursor: pointer">DKIM Configuration & DNS Record</summary>
                                <div class="row g-3 mt-2">
                                    <div class="col-12">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableDkimSigning"
                                                   @bind="EnableDkimSigning" />
                                            <label class="form-check-label" for="enableDkimSigning">
                                                Enable DKIM Signing
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <label class="form-label">DKIM Selector</label>
                                        <input class="form-control" @bind="DkimSelector" placeholder="e.g. blazorsmtp" />
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <label class="form-label">DKIM Domain</label>
                                        <input class="form-control" @bind="DkimDomain" placeholder="e.g. @DkimDomain" />
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">DKIM Private Key (RSA)</label>
                                        <div class="mb-2">
                                            <button type="button" class="btn btn-secondary btn-sm" @onclick="GenerateNewDkimKeys">Create New Keys</button>
                                        </div>
                                        <textarea class="form-control" @bind="DkimPrivateKey" rows="5" style="font-family: monospace; font-size: 0.8rem;"></textarea>
                                    </div>
                                </div>

                                <hr class="my-4" />

                                <h5 class="card-title">DKIM Record (Public Key)</h5>
                                <p>Add this TXT record to your DNS settings.</p>
                                @if (!string.IsNullOrEmpty(DkimPublicKeyRecord))
                                {
                                    <div class="alert alert-secondary" style="word-break: break-all; font-family: monospace;">
                                        <strong>Host/Name:</strong> @(DkimSelector ?? "selector")._domainkey<br />
                                        <strong>Value:</strong> @DkimPublicKeyRecord
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-warning">
                                        Configure and save DKIM settings above to generate the DNS record.
                                    </div>
                                }
                                <div class="col-12">
                                    <button class="btn btn-primary" @onclick="SaveAsync" disabled="@(Saving || IsLoading)">Save Settings</button>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>
            </RadzenTabsItem>

            <RadzenTabsItem Text="SPAM">
                <div class="p-3">
                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Spam Configuration (configured in appsettings.json)</h5>
                            <div class="row g-3">
                                <div class="col-12 col-md-6">
                                    <br />
                                    <label class="form-label" for="spamhausKey">Spamhaus Key</label>
                                    <div class="input-group">
                                        <input id="spamhausKey" class="form-control" autocomplete="off"
                                               type="@(ShowSpamhausKey ? "text" : "password")"
                                               placeholder="(not set)" value="@SpamhausKey" readonly
                                               disabled />
                                        <button class="btn btn-outline-secondary" type="button"
                                                @onclick="() => ShowSpamhausKey = !ShowSpamhausKey">
                                            @(ShowSpamhausKey ? "Hide" : "Show")
                                        </button>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex flex-wrap gap-4 mt-2">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox"
                                                   id="enableSpamFilter" checked="@EnableSpamFiltering"
                                                   disabled />
                                            <label class="form-check-label" for="enableSpamFilter">
                                                Enable
                                                Spam Filtering
                                            </label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableDmarc"
                                                   checked="@EnableDmarcCheck" disabled />
                                            <label class="form-check-label" for="enableDmarc">
                                                Enable DMARC
                                                Check
                                            </label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableSpf"
                                                   checked="@EnableSpfCheck" disabled />
                                            <label class="form-check-label" for="enableSpf">
                                                Enable SPF
                                                Check
                                            </label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableDkim"
                                                   checked="@EnableDkimCheck" disabled />
                                            <label class="form-check-label" for="enableDkim">
                                                Enable DKIM
                                                Check
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="m-0">Spam Logs</h5>
                        <div class="d-flex gap-2">
                            <RadzenButton Icon="refresh" ButtonStyle="ButtonStyle.Light" Click="@LoadSpamLogsAsync"
                                          Size="ButtonSize.Small" Disabled="@IsLoadingSpam" />
                            @if (_spamHasMore && !IsLoadingSpam)
                            {
                                <RadzenButton Icon="add" Text="More" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Click="@LoadMoreSpamLogsAsync" />
                            }
                        </div>
                    </div>

                    @if (IsLoadingSpam && (SpamLogs == null || SpamLogs.Count == 0))
                    {
                        <div class="text-center p-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else if (SpamLogs == null || !SpamLogs.Any())
                    {
                        <div class="text-muted">No spam logs found.</div>
                    }
                    else
                    {
                        <RadzenDataGrid Data="@SpamLogs" TItem="SpamLog" AllowPaging="true" PageSize="10"
                                        AllowSorting="true" ColumnWidth="150px">
                            <Columns>
                                <RadzenDataGridColumn TItem="SpamLog" Property="Timestamp" Title="Time" Width="160px">
                                    <Template Context="data">
                                        @data.Timestamp?.ToLocalTime().ToString("g")
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="SpamLog" Property="From" Title="From" Width="200px" />
                                <RadzenDataGridColumn TItem="SpamLog" Property="To" Title="To" Width="200px" />
                                <RadzenDataGridColumn TItem="SpamLog" Property="Subject" Title="Subject" />
                                <RadzenDataGridColumn TItem="SpamLog" Property="IP" Title="IP" Width="120px" />
                            </Columns>
                        </RadzenDataGrid>
                        @if (IsLoadingSpam && SpamLogs.Count > 0)
                        {
                            <div class="mt-2 text-muted">Loading more...</div>
                        }
                    }
                </div>
            </RadzenTabsItem>



        </Tabs>
    </RadzenTabs>
</div>

@code {
    const string TableName = "SMTPSettings";
    const string PK = "SmtpServer";
    const string RKSettings = "Current";

    string? ServerName; string? Ports; string? AllowedRecipient; string? AllowedUsername; string? AllowedPassword; string?
    AppPassword; string? SpamhausKey; string? SpamhausAccount;
    string? DkimPrivateKey; string? DkimSelector; string? DkimDomain;
    bool Saved; string? Error;

    bool IsLoading; bool Saving; bool ShowAllowedPassword; bool ShowSpamhausKey; bool ShowAppPassword;

    bool EnableSpamFiltering; bool EnableSpfCheck; bool EnableDmarcCheck; bool EnableDkimCheck; bool EnableDkimSigning;

    bool IsVerifyingMX;
    string? MxResult;
    bool MxSuccess;

    bool IsVerifyingSPF;
    string? SpfResult;
    bool SpfSuccess;

    bool IsVerifyingDMARC;
    string? DmarcResult;
    bool DmarcSuccess;

    string? DkimPublicKeyRecord;

    async Task OpenTestServerDialog()
    {
        await DialogService.OpenAsync<SmtpTest>("SMTP Server Test",
               null,
               new DialogOptions() { Width = "800px", Height = "800px", Resizable = true, Draggable = true });
    }

    // Spam Log Logic
    List<SpamLog>? SpamLogs;
    bool IsLoadingSpam;
    string? _spamContinuationToken; // paging token
    bool _spamHasMore; // more pages flag
    readonly int _spamPageSize = 200; // page size for table query

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
        _ = LoadSpamLogsAsync();
    }

    async Task LoadAsync()
    {
        IsLoading = true; Error = null; Saved = false;
        try
        {
            var table = Tables.GetTableClient(TableName);
            await table.CreateIfNotExistsAsync();
            var settings = await table.GetEntityIfExistsAsync<TableEntity>(PK, RKSettings);
            if (settings.HasValue)
            {
                ServerName = settings.Value?.GetString("ServerName");
                Ports = settings.Value?.GetString("Ports");
                AllowedRecipient = settings.Value?.GetString("AllowedRecipient");
                AllowedUsername = settings.Value?.GetString("AllowedUsername");
                AllowedPassword = settings.Value?.GetString("AllowedPassword");

                SpamhausKey = Config["SmtpServer:SpamhausKey"];
                if (string.IsNullOrEmpty(SpamhausKey))
                {
                    SpamhausKey = settings.Value?.GetString("SpamhausKey");
                }

                SpamhausAccount = settings.Value?.GetString("SpamhausAccount");

                EnableSpamFiltering = settings.Value?.GetBoolean("EnableSpamFiltering") ?? false;
                EnableSpfCheck = settings.Value?.GetBoolean("EnableSpfCheck") ?? false;
                EnableDmarcCheck = settings.Value?.GetBoolean("EnableDmarcCheck") ?? false;
                EnableDkimCheck = settings.Value?.GetBoolean("EnableDkimCheck") ?? false;

                DkimPrivateKey = settings.Value?.GetString("DkimPrivateKey");
                DkimSelector = settings.Value?.GetString("DkimSelector");
                if (string.IsNullOrEmpty(DkimSelector)) DkimSelector = "blazorsmtp";
                DkimDomain = settings.Value?.GetString("DkimDomain");
                if (string.IsNullOrEmpty(DkimDomain)) DkimDomain = ServerName;
                EnableDkimSigning = settings.Value?.GetBoolean("EnableDkimSigning") ?? false;

                if (!string.IsNullOrEmpty(DkimPrivateKey))
                {
                    GenerateDkimDnsRecord();
                }
            }
            AppPassword = Config["AppPassword"];
        }
        catch (Exception ex) { Error = ex.Message; Log.LogError(ex, "Load failed"); }
        finally { IsLoading = false; }
    }

    async Task ResetAsync()
    {
        await LoadAsync();
    }

    async Task SaveAsync()
    {
        Error = null; Saved = false; Saving = true;
        try
        {
            await SaveAppPasswordToAppSettingsAsync(AppPassword ?? string.Empty);

            var table = Tables.GetTableClient(TableName);
            await table.CreateIfNotExistsAsync();

            var entity = new TableEntity(PK, RKSettings)
            {
                { "DkimPrivateKey", DkimPrivateKey },
                { "DkimSelector", DkimSelector },
                { "DkimDomain", DkimDomain },
                { "EnableDkimSigning", EnableDkimSigning }
            };
            await table.UpsertEntityAsync(entity, TableUpdateMode.Merge);

            Saved = true;
        }
        catch (Exception ex) { Error = ex.Message; Log.LogError(ex, "Save failed"); }
        finally { Saving = false; }
    }

    async Task SaveAppPasswordToAppSettingsAsync(string value)
    {
        var path = Path.Combine(Env.ContentRootPath, "appsettings.json");
        JsonObject root;
        try
        {
            if (File.Exists(path))
            {
                var json = await File.ReadAllTextAsync(path);
                root = JsonNode.Parse(json) as JsonObject ?? new JsonObject();
            }
            else
            {
                root = new JsonObject();
            }
        }
        catch
        {
            root = new JsonObject();
        }
        root["AppPassword"] = value;
        var options = new JsonSerializerOptions { WriteIndented = true };
        await File.WriteAllTextAsync(path, root.ToJsonString(options));
    }

    async Task VerifyMX()
    {
        IsVerifyingMX = true;
        MxResult = null;
        try
        {
            if (string.IsNullOrEmpty(ServerName))
            {
                MxResult = "Server Name (Domain) is not set.";
                MxSuccess = false;
                return;
            }

            var dnsClient = new DnsClient(HttpClientFactory);
            var response = await dnsClient.DnsQueryAsync(new DnsQuestion(ServerName, DnsRecordType.MX), DnsProvider.Google);

            if (response != null && response.Answer != null)
            {
                var mxRecords = response.Answer.Where(r => r.Type == DnsRecordType.MX).ToList();
                if (mxRecords.Any())
                {
                    MxResult = $"Found: {string.Join("; ", mxRecords.Select(r => r.Data))}";
                    MxSuccess = true;
                }
                else
                {
                    MxResult = "No MX records found.";
                    MxSuccess = false;
                }
            }
            else
            {
                MxResult = "No DNS records found.";
                MxSuccess = false;
            }
        }
        catch (Exception ex)
        {
            MxResult = $"Error: {ex.Message}";
            MxSuccess = false;
        }
        finally
        {
            IsVerifyingMX = false;
        }
    }

    async Task VerifySPF()
    {
        IsVerifyingSPF = true;
        SpfResult = null;
        try
        {
            if (string.IsNullOrEmpty(ServerName))
            {
                SpfResult = "Server Name (Domain) is not set.";
                SpfSuccess = false;
                return;
            }

            var dnsClient = new DnsClient(HttpClientFactory);
            var response = await dnsClient.DnsQueryAsync(new DnsQuestion(ServerName, DnsRecordType.TXT), DnsProvider.Google);

            if (response != null && response.Answer != null)
            {
                // TXT records might be quoted
                var spfRecord = response.Answer.FirstOrDefault(r => r.Data != null && r.Data.Trim('"').StartsWith("v=spf1"));
                if (spfRecord != null)
                {
                    SpfResult = $"Found: {spfRecord.Data}";
                    SpfSuccess = true;
                }
                else
                {
                    SpfResult = "No SPF record found.";
                    SpfSuccess = false;
                }
            }
            else
            {
                SpfResult = "No DNS records found.";
                SpfSuccess = false;
            }
        }
        catch (Exception ex)
        {
            SpfResult = $"Error: {ex.Message}";
            SpfSuccess = false;
        }
        finally
        {
            IsVerifyingSPF = false;
        }
    }

    async Task VerifyDMARC()
    {
        IsVerifyingDMARC = true;
        DmarcResult = null;
        try
        {
            if (string.IsNullOrEmpty(ServerName))
            {
                DmarcResult = "Server Name (Domain) is not set.";
                DmarcSuccess = false;
                return;
            }

            var dnsClient = new DnsClient(HttpClientFactory);
            var response = await dnsClient.DnsQueryAsync(new DnsQuestion($"_dmarc.{ServerName}", DnsRecordType.TXT), DnsProvider.Google);

            if (response != null && response.Answer != null)
            {
                var dmarcRecord = response.Answer.FirstOrDefault(r => r.Data != null && r.Data.Trim('"').StartsWith("v=DMARC1"));
                if (dmarcRecord != null)
                {
                    DmarcResult = $"Found: {dmarcRecord.Data}";
                    DmarcSuccess = true;
                }
                else
                {
                    DmarcResult = "No DMARC record found.";
                    DmarcSuccess = false;
                }
            }
            else
            {
                DmarcResult = "No DNS records found.";
                DmarcSuccess = false;
            }
        }
        catch (Exception ex)
        {
            DmarcResult = $"Error: {ex.Message}";
            DmarcSuccess = false;
        }
        finally
        {
            IsVerifyingDMARC = false;
        }
    }

    async Task LoadSpamLogsAsync()
    {
        // Initial load or refresh -> reset paging state
        _spamContinuationToken = null;
        _spamHasMore = true;
        SpamLogs = new List<SpamLog>();
        await LoadMoreSpamLogsAsync();
    }

    async Task LoadMoreSpamLogsAsync()
    {
        if (IsLoadingSpam || !_spamHasMore) return;
        IsLoadingSpam = true;
        try
        {
            var table = Tables.GetTableClient("spamlogs");
            await table.CreateIfNotExistsAsync();

            await foreach (var page in table.QueryAsync<TableEntity>().AsPages(_spamContinuationToken, _spamPageSize))
            {
                foreach (var entity in page.Values)
                {
                    // Map TableEntity -> SpamLog
                    var log = new SpamLog
                    {
                        PartitionKey = entity.PartitionKey,
                        RowKey = entity.RowKey,
                        Timestamp = ExtractSpamTimestamp(entity),
                        SessionId = entity.TryGetValue("SessionId", out var session) ? session?.ToString() : null,
                        TransactionId = entity.TryGetValue("TransactionId", out var txn) ? txn?.ToString() : null,
                        From = entity.TryGetValue("From", out var from) ? from?.ToString() : null,
                        To = entity.TryGetValue("To", out var to) ? to?.ToString() : null,
                        Subject = entity.TryGetValue("Subject", out var subj) ? subj?.ToString() : null,
                        BlobPath = entity.TryGetValue("BlobPath", out var blob) ? blob?.ToString() : null,
                        IP = entity.TryGetValue("IP", out var ip) ? ip?.ToString() : null
                    };
                    SpamLogs!.Add(log);
                }
                _spamContinuationToken = page.ContinuationToken;
                _spamHasMore = !string.IsNullOrEmpty(_spamContinuationToken);
                break; // only one page per call
            }

            // Order descending by timestamp after adding page
            SpamLogs = SpamLogs?.OrderByDescending(x => x.Timestamp).ToList();
        }
        catch (Exception ex)
        {
            Log.LogError(ex, "Failed to load spam logs page");
            _spamHasMore = false;
        }
        finally
        {
            IsLoadingSpam = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    static DateTimeOffset? ExtractSpamTimestamp(TableEntity entity)
    {
        try
        {
            if (entity.TryGetValue("Timestamp", out var tsObj) && tsObj is not null)
            {
                if (tsObj is DateTime dt) return new DateTimeOffset(dt.ToUniversalTime());
                if (tsObj is DateTimeOffset dto) return dto.ToUniversalTime();
                if (DateTime.TryParse(tsObj.ToString(), out var parsed)) return new DateTimeOffset(parsed.ToUniversalTime());
            }
        }
        catch { }
        return entity.Timestamp;
    }

    void GenerateNewDkimKeys()
    {
        try
        {
            var generator = new RsaKeyPairGenerator();
            var secureRandom = new SecureRandom();
            var keyGenerationParameters = new KeyGenerationParameters(secureRandom, 2048);
            generator.Init(keyGenerationParameters);
            var keyPair = generator.GenerateKeyPair();

            var privateKey = keyPair.Private;
            // var publicKey = keyPair.Public; // Not needed directly, derived from private

            // Convert private key to PEM format
            using var textWriter = new StringWriter();
            var pemWriter = new PemWriter(textWriter);
            pemWriter.WriteObject(privateKey);
            DkimPrivateKey = textWriter.ToString();

            // Set default selector/domain if empty
            if (string.IsNullOrEmpty(DkimSelector))
            {
                DkimSelector = "blazorsmtp";
            }
            if (string.IsNullOrEmpty(DkimDomain) && !string.IsNullOrEmpty(ServerName))
            {
                DkimDomain = ServerName;
            }

            // Generate public key record
            GenerateDkimDnsRecord();
        }
        catch (Exception ex)
        {
            Error = $"Error generating keys: {ex.Message}";
        }
    }

    void GenerateDkimDnsRecord()
    {
        if (string.IsNullOrEmpty(DkimPrivateKey))
        {
            DkimPublicKeyRecord = null;
            return;
        }

        try
        {
            using var reader = new StringReader(DkimPrivateKey);
            var pemReader = new PemReader(reader);
            var keyObject = pemReader.ReadObject();

            AsymmetricKeyParameter? privateKey = null;

            if (keyObject is AsymmetricCipherKeyPair keyPair)
            {
                privateKey = keyPair.Private;
            }
            else if (keyObject is AsymmetricKeyParameter keyParam && keyParam.IsPrivate)
            {
                privateKey = keyParam;
            }

            if (privateKey == null)
            {
                DkimPublicKeyRecord = "Invalid private key format.";
                return;
            }

            if (privateKey is Org.BouncyCastle.Crypto.Parameters.RsaPrivateCrtKeyParameters rsaPrivate)
            {
                var rsaPublic = new Org.BouncyCastle.Crypto.Parameters.RsaKeyParameters(false, rsaPrivate.Modulus, rsaPrivate.PublicExponent);
                var subjectPublicKeyInfo = Org.BouncyCastle.X509.SubjectPublicKeyInfoFactory.CreateSubjectPublicKeyInfo(rsaPublic);
                var bytes = subjectPublicKeyInfo.GetEncoded();
                var base64 = Convert.ToBase64String(bytes);

                DkimPublicKeyRecord = $"v=DKIM1; k=rsa; p={base64}";
            }
            else
            {
                DkimPublicKeyRecord = "Only RSA keys are supported for this display.";
            }
        }
        catch (Exception ex)
        {
            DkimPublicKeyRecord = $"Error parsing key: {ex.Message}";
        }
    }
}
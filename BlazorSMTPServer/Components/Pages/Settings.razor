@page "/settings"
@using Azure.Data.Tables
@using System.Text.Json
@using System.Text.Json.Nodes
@inject TableServiceClient Tables
@inject ILogger<Settings> Log
@inject IConfiguration Config
@inject IWebHostEnvironment Env

<div class="container py-4">
    <RadzenTabs>
        <Tabs>
            <RadzenTabsItem Text="SMTP Server">
                <div class="row justify-content-center">
                    <div class="col-12 col-lg-10">
                        @if (!string.IsNullOrEmpty(Error))
                        {
                            <div class="alert alert-danger" role="alert">@Error</div>
                        }
                        @if (Saved)
                        {
                            <div class="alert alert-success" role="alert">Saved.</div>
                        }

                        <form @onsubmit="SaveAsync" @onsubmit:preventDefault="true">
                            <div class="card shadow-sm mb-4">
                                <div class="card-header">
                                    <h1 class="h5 mb-0">App Access Password</h1>
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-2">
                                        <input id="appPassword" class="form-control" autocomplete="new-password" type="@(ShowAppPassword ? "text" : "password")" placeholder="Leave blank to disable app auth" @bind="AppPassword" />
                                        <button class="btn btn-outline-secondary" type="button" @onclick="() => ShowAppPassword = !ShowAppPassword">@(ShowAppPassword ? "Hide" : "Show")</button>
                                    </div>
                                    <div class="form-text mb-3">Protects access to this UI. Blank means open access. (Stored in appsettings.json)</div>
                                    <div class="d-flex align-items-center gap-2">
                                        <button type="submit" class="btn btn-primary" disabled="@(Saving || IsLoading)">
                                            @if (Saving)
                                            {
                                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                            }
                                            Save
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" @onclick="ResetAsync" disabled="@(Saving || IsLoading)">Reset</button>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h2 class="h5 mb-0">SMTP Settings (Read Only)</h2>
                            </div>
                            <div class="card-body">
                                @if (IsLoading)
                                {
                                    <div class="d-flex align-items-center gap-2 text-muted">
                                        <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
                                        <span>Loading settings…</span>
                                    </div>
                                }
                                else
                                {
                                    <div class="row g-3">
                                        <div class="col-12 col-md-6">
                                            <label class="form-label" for="serverName">Server Name</label>
                                            <input id="serverName" class="form-control" type="text" placeholder="smtp.example.com" @bind="ServerName" readonly />
                                            <div class="form-text">Hostname for the SMTP listener.</div>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <label class="form-label" for="ports">Ports</label>
                                            <input id="ports" class="form-control" type="text" placeholder="25, 587" @bind="Ports" readonly />
                                            <div class="form-text">Comma-separated list of ports to listen on.</div>
                                        </div>

                                        <div class="col-12 col-md-6">
                                            <label class="form-label" for="allowedRecipient">Allowed Recipient</label>
                                            <input id="allowedRecipient" class="form-control" type="email" placeholder="user@example.com" @bind="AllowedRecipient" readonly />
                                            <div class="form-text">Only accept mail where this is the recipient.</div>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <label class="form-label" for="allowedUsername">Allowed Username</label>
                                            <input id="allowedUsername" class="form-control" type="text" placeholder="username" @bind="AllowedUsername" readonly />
                                            <div class="form-text">SMTP auth username.</div>
                                        </div>

                                        <div class="col-12 col-md-6">
                                            <label class="form-label" for="allowedPassword">Allowed Password</label>
                                            <div class="input-group">
                                                <input id="allowedPassword" class="form-control" autocomplete="new-password" type="@(ShowAllowedPassword ? "text" : "password")" placeholder="Password" @bind="AllowedPassword" readonly />
                                                <button class="btn btn-outline-secondary" type="button" @onclick="() => ShowAllowedPassword = !ShowAllowedPassword">@(ShowAllowedPassword ? "Hide" : "Show")</button>
                                            </div>
                                            <div class="form-text">SMTP auth password.</div>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <label class="form-label" for="spamhausKey">Spamhaus Key</label>
                                            <div class="input-group">
                                                <input id="spamhausKey" class="form-control" autocomplete="off" type="@(ShowSpamhausKey ? "text" : "password")" placeholder="(not set)" @bind="SpamhausKey" readonly />
                                                <button class="btn btn-outline-secondary" type="button" @onclick="() => ShowSpamhausKey = !ShowSpamhausKey">@(ShowSpamhausKey ? "Hide" : "Show")</button>
                                            </div>
                                            <div class="form-text">Spamhaus API key.</div>
                                        </div>

                                        <div class="col-12">
                                            <div class="d-flex flex-wrap gap-4 mt-2">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="enableSpamFilter" @bind="EnableSpamFiltering" disabled />
                                                    <label class="form-check-label" for="enableSpamFilter">Enable Spam Filtering</label>
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="enableDmarc" @bind="EnableDmarcCheck" disabled />
                                                    <label class="form-check-label" for="enableDmarc">Enable DMARC Check</label>
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="enableSpf" @bind="EnableSpfCheck" disabled />
                                                    <label class="form-check-label" for="enableSpf">Enable SPF Check</label>
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="enableDkim" @bind="EnableDkimCheck" disabled />
                                                    <label class="form-check-label" for="enableDkim">Enable DKIM Check</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </RadzenTabsItem>

            <RadzenTabsItem Text="DNS">
                <div class="p-3 text-muted">DNS configuration guidance or settings can be added here.</div>
            </RadzenTabsItem>

            <RadzenTabsItem Text="SPAM">
                <div class="p-3 text-muted">Spam filtering and related settings can be added here.</div>
            </RadzenTabsItem>

            <RadzenTabsItem Text="SPF/DMARC/DKIM">
                <div class="p-3 text-muted">SPF, DMARC, and DKIM records and validation tools can be added here.</div>
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>
</div>

@code {
    const string TableName = "SMTPSettings"; 
    const string PK = "SmtpServer";
    const string RKSettings = "Current";

    string? ServerName; string? Ports; string? AllowedRecipient; string? AllowedUsername; string? AllowedPassword; string? AppPassword; string? SpamhausKey; string? SpamhausAccount;
    bool Saved; string? Error;

    bool IsLoading; bool Saving; bool ShowAllowedPassword; bool ShowSpamhausKey; bool ShowAppPassword;

    bool EnableSpamFiltering; bool EnableSpfCheck; bool EnableDmarcCheck; bool EnableDkimCheck;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    async Task LoadAsync()
    {
        IsLoading = true; Error = null; Saved = false;
        try
        {
            var table = Tables.GetTableClient(TableName);
            await table.CreateIfNotExistsAsync();
            var settings = await table.GetEntityIfExistsAsync<TableEntity>(PK, RKSettings);
            if (settings.HasValue)
            {
                ServerName = settings.Value?.GetString("ServerName");
                Ports = settings.Value?.GetString("Ports");
                AllowedRecipient = settings.Value?.GetString("AllowedRecipient");
                AllowedUsername = settings.Value?.GetString("AllowedUsername");
                AllowedPassword = settings.Value?.GetString("AllowedPassword");
                // Prefer secret value from configuration; otherwise read from table
                SpamhausKey = Config["SmtpServer:SpamhausKey"];
                if (string.IsNullOrEmpty(SpamhausKey))
                {
                    SpamhausKey = settings.Value?.GetString("SpamhausKey");
                }

                SpamhausAccount = settings.Value?.GetString("SpamhausAccount");

                EnableSpamFiltering = settings.Value?.GetBoolean("EnableSpamFiltering") ?? false;
                EnableSpfCheck = settings.Value?.GetBoolean("EnableSpfCheck") ?? false;
                EnableDmarcCheck = settings.Value?.GetBoolean("EnableDmarcCheck") ?? false;
                EnableDkimCheck = settings.Value?.GetBoolean("EnableDkimCheck") ?? false;
            }
            // Load only app password from configuration
            AppPassword = Config["AppPassword"];
        }
        catch (Exception ex) { Error = ex.Message; Log.LogError(ex, "Load failed"); }
        finally { IsLoading = false; }
    }

    async Task ResetAsync()
    {
        await LoadAsync();
    }

    async Task SaveAsync()
    {
        Error = null; Saved = false; Saving = true;
        try
        {
            // Only persist app password to appsettings.json. AllowedPassword remains table-sourced and read-only
            await SaveAppPasswordToAppSettingsAsync(AppPassword ?? string.Empty);

            Saved = true;
        }
        catch (Exception ex) { Error = ex.Message; Log.LogError(ex, "Save failed"); }
        finally { Saving = false; }
    }

    async Task SaveAppPasswordToAppSettingsAsync(string value)
    {
        var path = Path.Combine(Env.ContentRootPath, "appsettings.json");
        JsonObject root;
        try
        {
            if (File.Exists(path))
            {
                var json = await File.ReadAllTextAsync(path);
                root = JsonNode.Parse(json) as JsonObject ?? new JsonObject();
            }
            else
            {
                root = new JsonObject();
            }
        }
        catch
        {
            root = new JsonObject();
        }
        root["AppPassword"] = value;
        var options = new JsonSerializerOptions { WriteIndented = true };
        await File.WriteAllTextAsync(path, root.ToJsonString(options));
    }
}

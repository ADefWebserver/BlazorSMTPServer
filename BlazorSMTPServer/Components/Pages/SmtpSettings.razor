@page "/settings"
@using Azure.Data.Tables
@inject TableServiceClient Tables
@inject ILogger<SmtpSettings> Log

<h1>SMTP Settings</h1>

@if (!string.IsNullOrEmpty(Error))
{
    <div class="alert alert-danger">@Error</div>
}
@if (Saved)
{
    <div class="alert alert-success">Saved.</div>
}

<form @onsubmit="SaveAsync">
    <input placeholder="Server Name" @bind="ServerName" /> <br />
    <input placeholder="Ports (comma separated)" @bind="Ports" /> <br />
    <input placeholder="Allowed Recipient" @bind="AllowedRecipient" /> <br />
    <input placeholder="Allowed Username" @bind="AllowedUsername" /> <br />
    <input type="password" placeholder="Allowed Password" @bind="AllowedPassword" /> <br />
    <input placeholder="Blob Container Name" @bind="BlobContainerName" /> <br />
    <input placeholder="Log Table Name" @bind="LogTableName" /> <br />
    <input type="password" placeholder="App Access Password (blank=open)" @bind="AppPassword" /> <br />
    <button type="submit">Save</button>
</form>

@code {
    const string TableName = "SMPTSettings"; // requested spelling
    const string PK = "SmtpServer";
    const string RKSettings = "Current";
    const string RKAppPwd = "AppPassword";

    string? ServerName; string? Ports; string? AllowedRecipient; string? AllowedUsername; string? AllowedPassword; string? BlobContainerName; string? LogTableName; string? AppPassword;
    bool Saved; string? Error;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var table = Tables.GetTableClient(TableName);
            await table.CreateIfNotExistsAsync();
            var settings = await table.GetEntityIfExistsAsync<TableEntity>(PK, RKSettings);
            if (settings.HasValue)
            {
                ServerName = settings.Value.GetString("ServerName");
                Ports = settings.Value.GetString("Ports");
                AllowedRecipient = settings.Value.GetString("AllowedRecipient");
                AllowedUsername = settings.Value.GetString("AllowedUsername");
                AllowedPassword = settings.Value.GetString("AllowedPassword");
                BlobContainerName = settings.Value.GetString("BlobContainerName");
                LogTableName = settings.Value.GetString("LogTableName");
            }
            var pwd = await table.GetEntityIfExistsAsync<TableEntity>(PK, RKAppPwd);
            if (pwd.HasValue) AppPassword = pwd.Value.GetString("Password");
        }
        catch (Exception ex) { Error = ex.Message; Log.LogError(ex, "Load failed"); }
    }

    async Task SaveAsync()
    {
        Error = null; Saved = false;
        try
        {
            var table = Tables.GetTableClient(TableName);
            await table.CreateIfNotExistsAsync();
            var entity = new TableEntity(PK, RKSettings)
            {
                {"ServerName", ServerName ?? string.Empty},
                {"Ports", Ports ?? string.Empty},
                {"AllowedRecipient", AllowedRecipient ?? string.Empty},
                {"AllowedUsername", AllowedUsername ?? string.Empty},
                {"AllowedPassword", AllowedPassword ?? string.Empty},
                {"BlobContainerName", BlobContainerName ?? string.Empty},
                {"LogTableName", LogTableName ?? string.Empty}
            };
            await table.UpsertEntityAsync(entity);
            var pwdEntity = new TableEntity(PK, RKAppPwd) { {"Password", AppPassword ?? string.Empty} };
            await table.UpsertEntityAsync(pwdEntity);
            Saved = true;
        }
        catch (Exception ex) { Error = ex.Message; Log.LogError(ex, "Save failed"); }
    }
}
